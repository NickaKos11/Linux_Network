## Part 1. Инструмент ipcalc
> **ipcalc** - выполняет простые операции с IP-адресами  
* Устанавливаем утилиту ipcalc командой `sudo apt install ipcalc`:

![install ipcalc](/src/images/part1.1.png "Установка ipcalc")

### 1.1. Сети и маски
1. Чтобы определить адрес сети 192.167.38.54/13 используем команду `ipcalc 192.167.38.54/13`:

![ipcalc 192.167.38.54/13](/src/images/part1.2.png "ipcalc 192.167.38.54/13")

* Адрес сети: 192.160.0.0/13

2. a) Перевод маски 255.255.255.0 в префиксную и двоичную запись (команда `ipcalc 192.167.38.54/255.255.255.0`): 

![ipcalc 192.167.38.54/255.255.255.0](/src/images/part1.3.png "ipcalc 192.167.38.54/255.255.255.0")

* Маска в префиксной записи: /24
* Маска в двоичной записи: 11111111.11111111.11111111.00000000

б) Перевод маски /15 в обычную и двоичную запись (команда `ipcalc 192.167.38.54/15`): 

![ipcalc 192.167.38.54/15](/src/images/part1.4.png "ipcalc 192.167.38.54/15")

* Маска в обычной записи: 255.254.0.0
* Маска в двоичной записи: 11111111.11111110.00000000.00000000

в) Перевод маски 11111111.11111111.11111111.11110000 в обычную и префиксную запись (команда `ipcalc 192.167.38.54/28`): 

![ipcalc 192.167.38.54/28](/src/images/part1.5.png "ipcalc 192.167.38.54/28")

* Маска в обычной записи: 255.255.255.240
* Маска в префиксной записи: /28

3. а) Минимальный и максимальный хост в сети 12.167.38.4 при маске /8:

![ipcalc 12.167.38.4/8](/src/images/part1.6.png "ipcalc 12.167.38.4/8")

* Минимальный хост: 12.0.0.1
* Максимальный хост: 12.255.255.254

б) Минимальный и максимальный хост в сети 12.167.38.4 при маске 11111111.11111111.00000000.00000000:

![ipcalc 12.167.38.4/16](/src/images/part1.7.png "ipcalc 12.167.38.4/16")

* Минимальный хост: 12.167.0.1
* Максимальный хост: 12.167.255.254


в) Минимальный и максимальный хост в сети 12.167.38.4 при маске 255.255.254.0:

![ipcalc 12.167.38.4/255.255.254.0](/src/images/part1.8.png "ipcalc 12.167.38.4/255.255.254.0")

* Минимальный хост: 12.167.38.1
* Максимальный хост: 12.167.39.254

г) Минимальный и максимальный хост в сети 12.167.38.4 при маске /4:

![ipcalc 12.167.38.4/4](/src/images/part1.9.png "ipcalc 12.167.38.4/4")

* Минимальный хост: 0.0.0.1
* Максимальный хост: 15.255.255.254

### 1.2. localhost
> **localhost** — в компьютерных сетях, стандартное, официально зарезервированное доменное имя для частных IP-адресов (в диапазоне 127.0.0.1 — 127.255.255.254).
* Можно ли обратиться к приложению, работающему на localhost, со следующими IP:
1) 194.34.23.100 - нет

![ipcalc 194.34.23.100](/src/images/part1.10.png "ipcalc 194.34.23.100")

2) 127.0.0.2 - да

![ipcalc 127.0.0.2](/src/images/part1.11.png "ipcalc 127.0.0.2")

3) 127.1.0.1 - да

![ipcalc 127.1.0.1](/src/images/part1.12.png "ipcalc 127.1.0.1")

4) 128.0.0.1 - нет

![ipcalc 128.0.0.1](/src/images/part1.13.png "ipcalc 128.0.0.1")

### 1.3. Диапазоны и сегменты сетей
> IP бывают белые и серые (или публичные и частные). Публичным IP адресом называется IP адрес, который используется для выхода в Интернет. Адреса, используемые в локальных сетях, относят к частным. Частные IP не маршрутизируются в Интернете.

![Частные ip адреса](/src/images/part1.14.png "Частные ip адреса")

* IP, которые можно использовать только в качестве частных: (в выводе команды ipcalc есть строка `Private Internet`):
1) 10.0.0.45
2) 192.168.4.2
3) 172.20.250.4
4) 172.16.255.255
5) 10.10.10.10

* IP, которые можно использовать в качестве публичных:
1) 134.43.0.2
2) 172.0.2.1
3) 192.172.0.1
4) 172.68.0.2
5) 192.169.168.1

* Диапазон адресов для сети 10.10.0.0/18: 10.10.0.1 - 10.10.63.254

![ipcalc 10.10.0.0/18](/src/images/part1.15.png "ipcalc 10.10.0.0/18")

* В данный диапазон попадают адреса 10.10.0.2, 10.10.10.10, 10.10.1.255

## Part 2. Статическая маршрутизация между двумя машинами
* Cуществующие сетевые интерфейсы (команда `ip a`): 

![ip a](/src/images/part2.1.png "Cуществующие сетевые интерфейсы")

> **Виды сетевых адаптеров в VirtualBox**:  
  **NAT** - этот способ используется по умолчанию. Для каждой машины создается отдельная внутренняя локальная сеть, в которой машина получает ip 10.10.0.1. Машина может связаться с интернетом, используя технологию NAT, и вы можете обратиться к машине, используя проброс портов VirtualBox, но если у вас будет две виртуальные машины, то вы уже не сможете между ними так взаимодействовать;  
   **Виртуальный адаптер хоста** - создается виртуальный сетевой адаптер, к которому можно подключить несколько виртуальных машин, тем самым объединив их в локальную сеть. Доступа к интернету нет, но зато машины находятся в одной сети и каждая имеет свой ip адрес, теперь они могут взаимодействовать между собой. Основная система тоже доступна по ip 192.168.56.1. Машины доступны не только между собой, но и из основной системы;  
  **Сетевой мост** - при таком подключении виртуальная машина становится полноценным членом локальной сети, к которой подключена основная система. Машина использует сетевой интерфейс чтобы получить адрес у роутера и становится доступна для других устройств, как и основной компьютер по своему ip адресу.  
  **Внутренняя сеть** - почти то же самое, что и виртуальный адаптер хоста, только без возможности доступа к виртуальной сети из основной системы, доступа к интернету нет.  
  **Универсальный драйвер** - позволяет использовать драйвер из расширений VirtualBox для связи между машинами, расположенными на разных физических хостах.

* Выключим машины и включим второй адаптер для машин ws1 и ws2 (внутренняя сеть): 

![Адаптер 2 в VirtualBox](/src/images/part2.2.png "Адаптер 2 в VirtualBox")

* Для сетевого интерфейса enp0s3 включаем DHCP. Для сетевого интерфейса enp0s8 устанавливаем IP адрес внутренней сети (для ws1 ip адрес 192.168.100.10/16, для ws2 - 172.24.116.8/12) в файле etc/netplan/00-installer-config.yaml: 

![new ip for ws1, ws2](/src/images/part2.3.png "Изменённый файл etc/netplan/00-installer-config.yaml")

* Команда `netplan apply` для перезапуска сервиса сети:

![netplan apply](/src/images/part2.4.png "Netplan apply")

### 2.1. Добавление статического маршрута вручную
* Добавим статический маршрут от одной машины до другой при помощи команды вида `ip r add` и пропингуем соединение между машинами: 

![ip r add and ping](/src/images/part2.5.png "ip r add and ping")

### 2.2. Добавление статического маршрута с сохранением
* Перезапустим машины командой `sudo reboot`.
* Изменим файл etc/netplan/00-installer-config.yaml: 

![new config](/src/images/part2.6.png "Изменённый файл etc/netplan/00-installer-config.yaml")

* Применим изменения командой `netplan apply` и пропингуем соединения между машинами: 

![ping ws1 and ws2](/src/images/part2.7.png "ping ws1 and ws2")

## Part 3. Утилита iperf3
> 1 Megabytes/sec(MB/s) = 8 Megabit/s (Mbps);  
   1 MB/s = 8000 Kbps;  
   1 Gigabytes/sec (Gbps) =  125 MB/s.

* 8 Mbps = 1 MB/s
* 100 MB/s = 800000 Kbps
* 1 Gbps = 1000 MB/s

### 3.1. Скорость соединения
* Устанавливаем утилиту iperf3 на обоих машинах командой `sudo apt install iperf3`.
* На первой машине вводим команду `iperf 3 -c`, на второй `iperf3 -s 192.168.100.10`: 

![iperf3 (client ws2)](/src/images/part3.1.png "iperf3 - client ws2")

* Проделаем действия наоборот: 

![iperf3 (client ws1)](/src/images/part3.2.png "iperf3 - client ws1")

## Part 4. Сетевой экран
### 4.1. Утилита iptables
> **Сетевой порт** — то число, которое записывается в заголовках протоколов транспортного уровня сетевой модели OSI. Оно используется для определения программы или процесса-получателя пакета в пределах одного IP-адреса. Порты позволяют определить сетевые приложения, работающие на компьютере, множество которых может быть запущено одновременно.

> **iptables** — это утилита командной строки, используемая для управления встроенным брандмауэром netfilter, доступным в ядре Linux, начиная с версии 2.4. **Брандмауэр** — это приложение, на котором происходит фильтрация сетевого трафика на основе заданных администратором правил. Если правило не найдено, он возвращается к действию по умолчанию и предотвращает доступ к новому соединению.

* Создадим файл `/etc/firewall.sh` и добавим в него правила. Машина ws1 (сначала запрещающее правило, а затем разрешающее правило): 

![firewall.sh ws1](/src/images/part4.1.png "firewall.sh ws1")

* Машина ws2 (сначала разрешающее правило, затем запрещающее правило):

![firewall.sh ws2](/src/images/part4.2.png "firewall.sh ws2")

* Запустим файлы на обеих машинах командами `chmod +x /etc/firewall.sh` и `/etc/firewall.sh` и пропингуем машины: 

![firewall.sh and ping](/src/images/part4.3.png "firewall.sh and ping")

* Пакет последовательно проверяется в цепочке до первого соответствия критерию, после “срабатывания” остальные правила в цепочке не проверяются. Поэтому для первой машины срабатывает запрещающая стратегия, а для второй - разрешающая.

### 4.2. Утилита nmap
* Не пингуется машина ws1, однако утилита nmap показывет, что хост данной машины запущен: 

![nmap](/src/images/part4.4.png "nmap")

## Part 5. Статическая маршрутизация сети
* Поднимем 5 виртуальных машин ws11, ws21, ws22, r1, r2 и создадим новых пользователей. В настройках машин ws11, ws21, ws22 включим адаптер "Внутренняя сеть". Для ws11 с названием net1, для ws21, ws22 - net3. Для роутеров включим два адаптеры. Для r1 - net1 и net2, для r2 - net2 и net3.

![vb настройки машин](/src/images/part5.0.1.png "vb настройки машин")
![vb настройки роутеров](/src/images/part5.0.2.png "vb настройки роутеров")

### 5.1. Настройка адресов машин
* Зададим адреса машин согласно схеме, перезапустим сервис сети командой `sudo netplan apply` и проверим адрес командой `ip -4 a`:

![Сеть](/src/images/part5.1.png "Сеть")

* ws11: 

![config ws11](/src/images/part5.2.png "config ws11")
![ip -4 a ws11](/src/images/part5.3.png "ip -4 a ws11")

* ws21: 

![config ws21](/src/images/part5.4.png "config ws21")
![ip -4 a ws21](/src/images/part5.5.png "ip -4 a ws21")

* ws22: 

![config ws22](/src/images/part5.6.png "config ws22")
![ip -4 a ws22](/src/images/part5.7.png "ip -4 a ws22")

* r1: 

![config r1](/src/images/part5.8.png "config r1")
![ip -4 a r1](/src/images/part5.9.png "ip -4 a r1")

* r2: 

![config r2](/src/images/part5.10.png "config r2")
![ip -4 a r2](/src/images/part5.11.png "ip -4 a r2")

* Пропингуем ws22 с ws21: 

![ping ws22 and ws21](/src/images/part5.12.png "ping ws22 and ws21")

* Пропингуем r1 с ws11: 

![ping r1 and ws11](/src/images/part5.13.png "ping r1 and ws11")

### 5.2. Включение переадресации IP-адресов.
* Включим переадресацию, выполнив команду `sysctl -w net.ipv4.ip_forward=1` на роутерах (При таком подходе переадресация не будет работать после перезагрузки системы):

![Переадресация](/src/images/part5.14.png "Переадресация")

* Откроем файл /etc/sysctl.conf и добавим в него строку `net.ipv4.ip_forward = 1` (При использовании этого подхода, IP-переадресация включена на постоянной основе):

![Переадресация на ws1](/src/images/part5.15.png "Переадресация на ws1")

![Переадресация на ws2](/src/images/part5.16.png "Переадресация на ws2")

### 5.3. Установка маршрута по-умолчанию
* Настроим маршрут по-умолчанию (шлюз) для рабочих станций и проверим, что он добавился командой `ip r`.

* ws11: 

![default ws11](/src/images/part5.17.png "default ws11")
![ip r ws11](/src/images/part5.18.png "ip r ws11")

* ws21: 

![default ws21](/src/images/part5.19.png "default ws21")
![ip r ws21](/src/images/part5.20.png "ip r ws21")

* ws22: 

![default ws22](/src/images/part5.21.png "default ws22")
![ip r ws22](/src/images/part5.22.png "ip r ws22")

* Пропингуем ws11 c r2 - с помощью команды `tcpdump -tn -i enp0s8` видим, что пинг доходит:

![ping r2 by ws11](/src/images/part5.23.png "ping r2 by ws11")

### 5.4. Добавление статических маршрутов

* Добавим в роутеры r1 и r2 статические маршруты в файле конфигураций: 

* r1:

![Статические маршруты r1](/src/images/part5.24.png "Статические маршруты r1")

* Таблица с маршрутами роутера r1 (`ip r`): 

![Таблица с маршрутами роутера r1](/src/images/part5.25.png "Таблица с маршрутами роутера r1")

* r2: 

![Статические маршруты r2](/src/images/part5.26.png "Статические маршруты r2")

* Таблица с маршрутами роутера r2 (`ip r`): 

![Таблица с маршрутами роутера r2](/src/images/part5.27.png "Таблица с маршрутами роутера r2")

* Запустить на ws11 команды `ip r list 10.10.0.0/18` и `ip r list 0.0.0.0/0`:

![ip r list ws11](/src/images/part5.28.png "ip r list ws11")

* Маршрут по умолчанию, который применяется ко всем отправляемым в сеть пакетам, не указанным в таблице маршрутизации. Поэтому для адреса 10.10.0.0/18 выбран другой маршртут, т.к он указан в таблице.

### 5.5. Построение списка маршрутизаторов
* Запустим на r1 команду дампа `tcpdump -tnv -i enp0s3`. При помощи утилиты traceroute построим список маршрутизаторов на пути от ws11 до ws21.

![traceroute to ws21 from ws11](/src/images/part5.29.png "traceroute to ws21 from ws11")

> **User Datagram Protocol (UDP)** - в отличие от TCP он обеспечивает передачу данных **без получения подтверждения** от пользователя. Проще говоря, просто отправляет пакеты и не ждет ничего в ответ.

> Для начала нужно вспомнить формат заголовка IP-пакета, точнее одно из его полей - **TTL (Time To Live)**. Это восьмибитное поле задает максимальное число хопов (hop - "прыжок" - прохождение дейтаграммы от одного маршрутизатора к другому) в течение которого пакет может находиться в сети. Каждый маршрутизатор, обрабатывающий эту дейтаграмму, выполняет операцию **TTL=TTL-1**. **Когда TTL становится равным нулю, маршрутизатор уничтожает пакет, отправителю высылается ICMP-сообщение Time Exceeded**.

> Утилита посылает в направлении заданного хоста пакет с TTL=1, и ждет, от кого вернется ответ time exceeded. Отвечающий записывается как первый хоп (результат первого шага на пути к цели). Затем посылаются последовательно пакеты с TTL=2, 3, 4 и т.д. по порядку, пока при некотором значении TTL пакет не достигнет цели и не получит от нее ответ.

> *nix traceroute посылает в сторону заданного хоста UDP-пакеты на произвольный порт - скорее всего не занятый другим сервисом (например 28942, 30471) или на зарезервированный. Сначала посылается серия из 3-х таких пакетов с TTL=1, по приходу ответов замеряется время прохождения и определяется доменное имя транзитного узла (хотя это зависит от заданных опций). Затем, посылаются очередные серии пакетов с одинаковым TTL, предназначенных для выявления одного и того же хопа. В конце мы получаем от конечного хоста отклик port unreachable (порт недоступен), что означает завершение трассировки.

### 5.6. Использование протокола ICMP при маршрутизации

* Запустим на r1 перехват сетевого трафика, проходящего через enp0s3 с помощью команды `tcpdump -n -i enp0s3 icmp`.
* Пропингуем с ws11 несуществующий IP  10.30.0.111 с помощью команды `ping -c 1 10.30.0.111`: 

![icmp](/src/images/part5.30.png "icmp")

* Сохраняем дампы виртуальных машин.

## Part 6. Динамическая настройка IP с помощью DHCP
* Установим службу isc-dhcp-server командой `sudo apt install isc-dhcp-server`.
* Для r2 настроим в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP (указываем адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети):

![Конфигурация службы DHCP](/src/images/part6.1.png "Конфигурация службы DHCP")

* В файле resolv.conf пропишем nameserver 8.8.8.8: 

![resolv.conf](/src/images/part6.2.png "resolv.conf")

* Перезагрузим службу DHCP командой systemctl restart isc-dhcp-server: 

![restart isc-dhcp-server](/src/images/part6.3.png "restart isc-dhcp-server")

Машину ws21 перезагрузим при помощи reboot. Вызываем команду `ip a` и видим, что машина получила адрес:

![address ws21](/src/images/part6.4.png "address ws21")

* Также пропингуем ws22 с ws21: 

![ping ws22 by ws21](/src/images/part6.5.png "ping ws22 by ws21")

* Указываем MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: macaddress: 10:10:10:10:10:BA, dhcp4: true :

![macaddress ws11](/src/images/part6.6.png "macaddress ws111")

* Настраиваем r1 аналогично r2, но сделаем выдачу адресов с жесткой привязкой к MAC-адресу (ws11): 

![Конфигурация службы DHCP](/src/images/part6.7.png "Конфигурация службы DHCP")

* В файле resolv.conf пропишем nameserver 8.8.8.8: 

![resolv.conf](/src/images/part6.8.png "resolv.conf")

* Перезагрузим службу DHCP командой systemctl restart isc-dhcp-server: 

![restart isc-dhcp-server](/src/images/part6.9.png "restart isc-dhcp-server")

* Машину ws11 перезагрузим при помощи reboot. Вызываем команду `ip a` и видим, что машина получила адрес:

![address ws11](/src/images/part6.10.png "address ws11")

* Запросим с ws21 обновление ip адреса: Сначала сбросим существующий IP-адрес командой `sudo dhclient -r enp0s3`. Затем получим IP-адрес командой `sudo dhclient -v enp0s3`. Снова вызываем `ip a` и видим, что адрес изменился.

![address ws21](/src/images/part6.11.png "address ws21")

* Сохраняем дампы виртуальных машин.

## Part 7. NAT

* В файле /etc/apache2/ports.conf на ws22 и r1 изменим строку Listen 80 на Listen 0.0.0.0:80, то есть сделаем сервер Apache2 общедоступным: 

* ws22:

![ports.conf ws22](/src/images/part7.1.png "ports.conf ws22")

* r1:

![ports.conf r1](/src/images/part7.2.png "ports.conf r1")

* Запустим веб-сервер Apache командой service apache2 start на ws22 и r1:

* ws22:

![service apache2 start ws22](/src/images/part7.3.png "service apache2 start ws22")

* r1:

![service apache2 start r1](/src/images/part7.4.png "service apache2 start r1")

* Добавим в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:

1) удаление правил в таблице filter - iptables -F
2) удаление правил в таблице "NAT" - iptables -F -t nat
3) отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP

![firewall r2](/src/images/part7.5.png "firewall r2")

* Запустим файлы командами `chmod +x /etc/firewall.sh` и `/etc/firewall.sh` и пропингуем машины ws22 и r1. Как и ожидалось, ws22 не пингуется с r1:

![ping ws22 by r1](/src/images/part7.6.png "ping ws22 by r1")

* Добавим в файл ещё одно правило:
4) разрешить маршрутизацию всех пакетов протокола ICMP

> **—append, -A** - добавить правило в конец указанной цепочки;
> **FORWARD** — для проходящих пакетов, не адресованных этому компьютеру, предназначены для передачи следующему узлу, в случае, если сервер выполняет роль маршрутизатора;
> **—protocol, -p** - указывает протокол, такие как tcp, udp, udplite и другие, поддерживаемые системой.

![firewall r2](/src/images/part7.7.png "firewall r2")

* Снова запустим файл и пропингуем машины. Пинг идет: 

![successful ping ws22 by r1](/src/images/part7.8.png "successful ping ws22 by r1")

* Включим SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0). А также DNAT на 8080 порт машины r2 и добавим к веб-серверу Apache, запущенному на ws22, доступ извне сети: 

![DNAT and SNAT](/src/images/part7.9.png "DNAT and SNAT")

> **SNAT (Source Network Address Translation)** — изменение адреса и порта источника пакета. Применимо, когда за сервером находятся машины, которым необходимо предоставить доступ в Интернет, при этом от провайдера имеется статический IP-адрес. Доступен в цепочке **POSTROUTING**.

>  **Ключ -t** указывает используемую таблицу, если данный ключ не указан, то по умолчанию используется таблица filter. Запись добавляется в цепочку **POSTROUTING** и предписывает выполнить действие **SNAT** для всех пакетов, попадающих под критерий **-o enp0s8**, т.е. использующих в качестве исходящего внешний интерфейс enp0s8. Для SNAT обязательно указывается параметр **--to-source**, который используется для указания адреса, присваиваемому пакету, теперь именно этот адрес будет указываться в качестве исходящего. Явно задаем диапазон адресов для преобразования: 10.20.0.0/26.

> **DNAT - Destination Network Address Translation** - изменение адреса и порта назначения пакета, доступен в цепочках **PREROUTING и OUTPUT**.

> Данное правило изменит адрес назначения всех пакетов пришедших на внешний интерфейс enp0s3 по протоколу tcp с портом назначения TCP-сегмента 8080 на адрес внутреннего сервера 10.20.0.20 с портом 80. 

* Запустим файл. Проверим соединение по TCP для SNAT, для этого с ws22 подключимся к серверу Apache на r1 командой `telnet 10.100.0.11 80`:

![telnet r1 by ws22](/src/images/part7.10.png "telnet r1 by ws22")

* Проверим соединение по TCP для DNAT, для этого с r1 подключимся к серверу Apache на ws22 командой telnet (обращаемся по адресу r2 и порту 8080): 

![telnet r2 by r1](/src/images/part7.11.png "telnet r2 by r1")

* Сохраняем дампы виртуальных машин.

## Part 8. Бонус. Знакомство с SSH Tunnels
* Запустим на r2 фаервол с правилами из Части 7. 
* Запустим веб-сервер Apache на ws22 только на localhost (то есть в файле /etc/apache2/ports.conf изменим строку Listen 80 на Listen localhost:80)

* Воспользуемся Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21. 

![Local TCP forwarding](/src/images/part8.1.png "Local TCP forwarding")

* Проверим соединение командой `telnet 127.0.0.1 9999`

![telnet](/src/images/part8.2.png "Local TCP forwarding")

* Воспользуемся Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11. На ws22 нужно будет выполнить подключение SSH-клиентом: 

![Remote TCP forwarding](/src/images/part8.3.png "Remote TCP forwarding")

* Проверим соединение командой `telnet 127.0.0.1 4444`

![telnet](/src/images/part8.4.png "Local TCP forwarding")
